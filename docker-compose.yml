version: '3.6'
services:
    webserver:
        image: nginx:alpine
        ports:
          - "80:80"
        hostname: mage.perf
        volumes:
          - project-data:/magento
          - ./etc/nginx/magento.conf:/etc/nginx/conf.d/default.conf
          - ./etc/nginx/xhgui.conf:/etc/nginx/conf.d/xhgui.conf
          - ./etc/nginx/nginx.conf:/etc/nginx/nginx.conf
          - ./xhgui:/xhgui
        environment:
          - VIRTUAL_HOST=mage.perf
        networks:
          default:
            aliases:
              - "mage.perf"
    app:
        build:
          context: build/php
          dockerfile: Dockerfile
          args:
            XDEBUG: 0
        hostname: app
        privileged: true
        volumes:
          - project-data:/magento
          - ./etc/php/php.ini:/usr/local/etc/php/php.ini:ro
          - ~/.ssh:/root/.ssh:ro
          -  ~/.composer:/root/.composer:delegated

    app-xdebug:
        build:
          context: build/php
          dockerfile: Dockerfile
          args:
            XDEBUG: 1
        hostname: app-xdebug
        volumes:
          - project-data:/magento
          - ./etc/php/php.ini:/usr/local/etc/php/php.ini:ro
          - ~/.ssh:/root/.ssh:ro
          - ~/.composer:/root/.composer:delegated

    db:
        image: mariadb:10.4
#        image: mysql:8
#        command: --default-authentication-plugin=mysql_native_password
        command:
          - --default-authentication-plugin=mysql_native_password
          - --max-allowed-packet=268435456
          - --optimizer-use-condition-selectivity=1
          - --optimizer-switch='rowid_filter=off'
          - --join-buffer-size=1048576
        ports:
          - "3306:3306"
        environment:
          - MYSQL_ROOT_PASSWORD=root
          - MYSQL_USER=magento
          - MYSQL_PASSWORD=magento
          - MYSQL_DATABASE=magento2
        volumes:
          - db-data:/var/lib/mysql

    redis:
        image: redis:6-alpine
        hostname: redis

    elastic:
        image: opensearchproject/opensearch:1.2.1
        hostname: elastic
        restart: always
        environment:
          - discovery.type=single-node
          - cluster.name=elastic-cluster
          - bootstrap.memory_lock=true
          - plugins.security.disabled=true
          - plugins.security.ssl.http.enabled=false
          - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
        ulimits:
          memlock:
            soft: -1
            hard: -1
          nofile:
            soft: 524288
            hard: 524288
        deploy:
          resources:
            limits:
              memory: 768M
            reservations:
              memory: 768M

    fluentbit:
        image: fluent/fluent-bit
        volumes:
          - ./etc/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf

volumes:
    project-data:
    db-data:
    elastic-data:

networks:
    default:
